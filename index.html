<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KeuanganKu HD - Persistent & Smooth</title>
    <style>
        /* Desain Santai & Kontras Tinggi (Soft UI) */
        @import url('https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap');

        :root {
            --primary: #4338ca;
            --primary-light: #6366f1;
            --primary-glow: rgba(67, 56, 202, 0.2);
            --success: #059669;
            --danger: #e11d48;
            --warning: #d97706;
            --bg-base: #f1f5f9;
            --card-bg: #ffffff;
            --text-main: #0f172a;
            --text-muted: #475569;
            --border: #cbd5e1;
            --input-bg: #f8fafc;
            --nav-bg: rgba(255, 255, 255, 0.95);
            --radius-L: 32px;
            --radius-M: 20px;
            --shadow-soft: 0 10px 30px -5px rgba(0,0,0,0.08);
            --bezier: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        [data-theme='dark'] {
            --primary: #a5b4fc;
            --primary-glow: rgba(165, 180, 252, 0.3);
            --success: #34d399;
            --danger: #fb7185;
            --warning: #fbbf24;
            --bg-base: #020617;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --input-bg: #0f172a;
            --nav-bg: rgba(15, 23, 42, 0.95);
            --shadow-soft: 0 10px 40px -10px rgba(0,0,0,0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0; padding: 0;
            font-family: 'Quicksand', sans-serif;
            background-color: var(--bg-base);
            color: var(--text-main);
            transition: background 0.4s ease, color 0.4s ease;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            font-weight: 600;
        }

        .container { width: 100%; max-width: 450px; padding: 20px; padding-bottom: 140px; }

        h1 { margin: 0; font-size: 0.95rem; font-weight: 700; color: var(--text-main); text-align: center; width: 100%; letter-spacing: 0.5px; text-transform: uppercase; }
        .text-xs { font-size: 0.75rem; font-weight: 600; color: var(--text-muted); }
        .text-xl { font-size: 2.2rem; font-weight: 700; margin: 5px 0; color: var(--primary); }

        .app-shell {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-L);
            overflow: hidden;
            box-shadow: var(--shadow-soft);
            width: 100%;
            transition: all 0.3s ease;
            margin-bottom: 24px;
        }

        .header-sticky {
            position: sticky; top: 0; z-index: 1100;
            backdrop-filter: blur(15px);
            background: var(--nav-bg);
            border-bottom: 1px solid var(--border);
            width: 100%; max-width: 450px;
            border-radius: 0 0 var(--radius-L) var(--radius-L);
            margin-bottom: 20px;
        }

        .section { padding: 24px; }
        .flex { display: flex; align-items: center; justify-content: space-between; }
        .gap-2 { gap: 12px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }

        .btn-main {
            width: 100%; padding: 18px; border-radius: var(--radius-M); border: none;
            background: var(--primary); color: #fff;
            font-weight: 700; cursor: pointer; font-size: 0.95rem;
            transition: 0.3s var(--bezier); box-shadow: 0 8px 25px -5px var(--primary-glow);
        }
        [data-theme='dark'] .btn-main { color: #020617; font-weight: 800; }
        .btn-main:active { transform: scale(0.95); }

        .input-hd {
            width: 100%; padding: 14px 18px; border-radius: var(--radius-M);
            border: 2px solid transparent; background: var(--input-bg);
            color: var(--text-main); font-weight: 700; margin-bottom: 12px;
            font-size: 0.95rem; transition: 0.3s;
        }
        .input-hd:focus { border-color: var(--primary); background: var(--card-bg); }

        .wallet-scroll { display: flex; gap: 12px; overflow-x: auto; padding: 5px 5px 15px 5px; scrollbar-width: none; }
        .wallet-scroll::-webkit-scrollbar { display: none; }
        .wallet-card { 
            min-width: 150px; padding: 22px; border-radius: var(--radius-M); 
            background: var(--card-bg); border: 2px solid var(--border); 
            flex-shrink: 0; box-shadow: 0 4px 15px rgba(0,0,0,0.02);
            transition: 0.3s var(--bezier);
        }

        .category-item {
            min-width: 65px; padding: 10px 2px; border-radius: var(--radius-M); border: 2px solid transparent;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s var(--bezier); background: var(--input-bg); flex-shrink: 0;
        }
        .category-item span:first-child { font-size: 1.4rem; margin-bottom: 3px; }
        .category-item span:last-child { font-size: 0.55rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
        .category-item.selected { border-color: var(--primary); background: var(--primary-glow); transform: translateY(-3px); }

        .wallet-icon-item {
            width: 55px; height: 55px; border-radius: 18px; background: var(--input-bg);
            display: flex; align-items: center; justify-content: center; font-size: 1.6rem;
            cursor: pointer; transition: 0.2s var(--bezier); border: 2.5px solid transparent;
        }
        .wallet-icon-item.selected { border-color: var(--primary); background: var(--primary-glow); transform: scale(1.1); }

        .item-row { padding: 16px 20px; background: var(--input-bg); border-radius: var(--radius-M); margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }

        .bottom-nav {
            position: fixed; bottom: 20px; width: 92%; max-width: 420px;
            background: var(--nav-bg); border: 1.5px solid var(--border);
            display: grid; grid-template-columns: repeat(6, 1fr);
            padding: 14px 0; z-index: 1200;
            border-radius: 50px; backdrop-filter: blur(25px);
            transition: transform 0.4s var(--bezier), opacity 0.3s;
            box-shadow: 0 15px 50px -10px rgba(0,0,0,0.2);
        }
        .nav-hidden { transform: translate(0, 150%); opacity: 0; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .nav-item.active { color: var(--primary); transform: translateY(-3px); }
        .nav-item svg { width: 22px; height: 22px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; padding: 25px; backdrop-filter: blur(10px); }
        .modal.active { display: flex; }
        .modal-content { background: var(--card-bg); width: 100%; max-width: 380px; border-radius: var(--radius-L); padding: 35px; box-shadow: 0 25px 60px -15px rgba(0, 0, 0, 0.4); border: none; }

        .chart-container { background: var(--input-bg); border-radius: var(--radius-M); padding: 24px; margin-bottom: 15px; }
        .glow-bar { height: 12px; background: rgba(0,0,0,0.08); border-radius: 6px; overflow: hidden; position: relative; margin-top: 8px; }
        .glow-fill-inc { height: 100%; background: var(--success); transition: width 1s ease; }
        .glow-fill-exp { height: 100%; background: var(--danger); transition: width 1s ease; }

        .toggle-switch { position: relative; display: inline-block; width: 52px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background-color: #94a3b8; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(24px); }

        #login-screen { position: fixed; inset: 0; background: var(--bg-base); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 3000; padding: 25px; text-align: center; }
        .login-card { background: var(--card-bg); padding: 55px 35px; border-radius: var(--radius-L); width: 100%; max-width: 360px; box-shadow: 0 20px 60px -15px rgba(0,0,0,0.15); }
        
        .hide { display: none !important; }
        .warning-badge { font-size: 10px; background: var(--danger); color: white; padding: 3px 10px; border-radius: 20px; font-weight: 800; letter-spacing: 0.5px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="toast" style="position:fixed; top:30px; left:50%; transform:translateX(-50%) translateY(-20px); padding:16px 32px; background:var(--text-main); color:var(--card-bg); border-radius:50px; font-weight:700; font-size:14px; opacity:0; pointer-events:none; transition:0.4s var(--bezier); z-index:11000; box-shadow: 0 15px 30px rgba(0,0,0,0.3);">Pesan</div>

    <!-- Login Screen -->
    <div id="login-screen">
        <div class="login-card">
            <div style="width:85px; height:85px; background:var(--primary); border-radius:26px; display:flex; align-items:center; justify-content:center; color:white; margin:0 auto 25px auto; font-size: 38px; box-shadow: 0 10px 25px var(--primary-glow);">üí∏</div>
            <h1 style="font-size:1.8rem; margin-bottom: 8px; text-transform: none;">KeuanganKu</h1>
            <p class="text-xs" style="opacity:0.6; margin-bottom:45px;">Kelola akun keuangan Anda</p>
            <input type="text" id="login-user" placeholder="Username" class="input-hd">
            <input type="password" id="login-pass" placeholder="Password" class="input-hd" style="margin-bottom: 35px;">
            <button onclick="handleLogin()" class="btn-main">MASUK SEKARANG</button>
            <p style="font-size: 11px; margin-top: 30px; opacity: 0.5;">Default: admin / 123</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="main-app" class="container hide">
        <header class="header-sticky">
            <div class="section" style="padding: 20px 25px;">
                <div class="flex">
                    <div style="text-align: left;">
                        <span id="full-date" class="text-xs" style="color:var(--primary); opacity: 0.8; margin-bottom: 4px; display: block; font-weight: 800;">MINGGU, 28 DESEMBER</span>
                        <h1 id="welcome-text" style="text-align: left; text-transform: none; font-size: 1.4rem;">Halo, User üëã</h1>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle" onchange="applyTheme(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </header>

        <!-- VIEW: BAKI -->
        <div id="view-finance" class="view-panel">
            <div class="app-shell">
                <div class="section" style="padding-bottom: 15px;">
                    <h1 style="text-align: left; opacity: 0.6; font-size: 0.85rem; font-weight: 800;">Saldo Terkumpul</h1>
                    <h2 class="text-xl" id="total-balance" style="color: var(--text-main); font-size: 2.5rem;">Rp 0</h2>
                </div>
                <div class="section" style="padding-top: 10px;">
                    <div id="wallets-container" class="wallet-scroll no-scrollbar"></div>
                </div>
            </div>

            <div class="app-shell">
                <div class="section">
                    <h1>Catat Transaksi</h1>
                    <p class="text-xs" style="text-align: center; margin: 20px 0 10px 0; font-weight: 800;">PILIH KATEGORI</p>
                    <div id="tx-icon-picker" class="wallet-scroll no-scrollbar" style="gap:12px; justify-content: center;"></div>
                    
                    <div class="grid-2" style="margin-top: 25px;">
                        <div><p class="text-xs" style="margin-bottom:8px; font-weight: 800;">DARI SUMBER</p><select id="wallet-select" class="input-hd" style="margin:0;"></select></div>
                        <div id="to-wallet-container" class="hide"><p class="text-xs" style="margin-bottom:8px; color:var(--primary); font-weight: 800;">KE TUJUAN</p><select id="wallet-to-select" class="input-hd" style="margin:0;"></select></div>
                    </div>

                    <input type="text" id="desc" placeholder="Keterangan transaksi..." class="input-hd" style="margin-top: 20px;">
                    <input type="text" id="amount" placeholder="0" class="input-hd" style="font-size:1.8rem; text-align:center; padding: 24px; color: var(--primary); border: 2px dashed var(--primary-glow); margin-bottom: 25px;" oninput="formatAmountInput(this)">
                    
                    <div class="grid-3" style="margin-bottom: 25px;">
                        <button onclick="setTxMode('income')" id="btn-m-income" class="btn-main" style="background:var(--success); color: #fff;">MASUK</button>
                        <button onclick="setTxMode('expense')" id="btn-m-expense" class="btn-main" style="background:transparent; border: 2px solid var(--danger); color: var(--danger); box-shadow: none;">KELUAR</button>
                        <button onclick="setTxMode('transfer')" id="btn-m-transfer" class="btn-main" style="background:transparent; border: 2px solid var(--warning); color: var(--warning); box-shadow: none;">PINDAH</button>
                    </div>
                    <button onclick="processTransaction()" class="btn-main" style="background: var(--text-main); font-size: 1rem; border-radius: 1.5rem;">SIMPAN DATA</button>
                </div>
            </div>
        </div>

        <!-- VIEW: TAGIHAN -->
        <div id="view-bills" class="hide view-panel">
            <div class="app-shell">
                <div class="section">
                    <h1>Tagihan Berjangka</h1>
                    <input type="text" id="bill-name" placeholder="Nama Tagihan" class="input-hd">
                    <div class="grid-2">
                        <input type="date" id="bill-date" class="input-hd">
                        <input type="text" id="bill-amount" placeholder="Nominal" class="input-hd" oninput="formatAmountInput(this)">
                    </div>
                    <label class="flex gap-2" style="font-size: 0.85rem; margin-bottom: 20px; cursor: pointer; color: var(--text-muted);">
                        <input type="checkbox" id="bill-is-variable" style="width: 18px; height: 18px;"> Nominal bisa berubah
                    </label>
                    <button onclick="addNewBill()" class="btn-main">TAMBAH TAGIHAN</button>
                </div>
                <div class="section" id="bill-list-full" style="padding-top: 0;"></div>
            </div>
        </div>

        <!-- VIEW: TARGET -->
        <div id="view-goals" class="hide view-panel">
            <div class="app-shell">
                <div class="section">
                    <h1>Target Impian</h1>
                    <input type="text" id="goal-name" class="input-hd" placeholder="Barang yang ingin dibeli">
                    <input type="text" id="goal-target" class="input-hd" placeholder="Harga Barang (Rp)" oninput="formatAmountInput(this)">
                    <button onclick="addNewGoal()" class="btn-main">MULAI MENABUNG</button>
                </div>
                <div class="section" id="goals-list" style="padding-top: 0;"></div>
            </div>
        </div>

        <!-- VIEW: ANGGARAN -->
        <div id="view-budget" class="hide view-panel">
            <div class="app-shell">
                <div class="section">
                    <h1>Limit Anggaran</h1>
                    <p class="text-xs" style="text-align: center; margin: 15px 0 15px 0;">PILIH KATEGORI</p>
                    <div id="budget-icon-picker" class="wallet-scroll no-scrollbar" style="margin-bottom:25px; gap:12px; justify-content: center;"></div>
                    <input type="text" id="budget-limit" class="input-hd" placeholder="Batas Maksimal (Rp)" oninput="formatAmountInput(this)">
                    <button onclick="saveBudget()" class="btn-main">PASANG BATAS</button>
                </div>
                <div class="section" id="budget-list" style="padding-top: 0;"></div>
            </div>
        </div>

        <!-- VIEW: LOG -->
        <div id="view-report" class="hide view-panel">
            <div class="app-shell">
                <div class="section">
                    <div class="flex" style="margin-bottom: 25px;">
                        <h1 style="text-align: left;">Arus Kas</h1>
                        <button onclick="openConfirmModal('Bersihkan semua log?', clearHistory)" style="border:none; background:rgba(225, 29, 72, 0.1); color:var(--danger); font-size: 11px; font-weight: 800; padding: 6px 12px; border-radius: 12px;">HAPUS SEMUA</button>
                    </div>
                    <div class="chart-container">
                        <div class="flex" style="margin-bottom:12px;">
                            <div><p class="text-xs" style="font-weight: 800;">MASUK</p><b id="chart-inc-val" style="color:var(--success); font-size: 1.1rem;">Rp 0</b></div>
                            <div style="text-align:right;"><p class="text-xs" style="font-weight: 800;">KELUAR</p><b id="chart-exp-val" style="color:var(--danger); font-size: 1.1rem;">Rp 0</b></div>
                        </div>
                        <div class="glow-bar"><div id="chart-inc-fill" class="glow-fill-inc"></div></div>
                        <div class="glow-bar" style="margin-top: 10px;"><div id="chart-exp-fill" class="glow-fill-exp"></div></div>
                    </div>
                </div>
                <div class="section" id="transaction-list" style="padding-top: 0;"></div>
            </div>
        </div>

        <!-- VIEW: MENU PENGATURAN -->
        <div id="view-options" class="hide view-panel">
            <div class="app-shell">
                <div class="section">
                    <h1>Profil & Keamanan</h1>
                    <input type="text" id="edit-name" class="input-hd" placeholder="Nama Tampilan Baru">
                    <input type="text" id="edit-user" class="input-hd" placeholder="Username Login Baru">
                    <input type="password" id="edit-pass" class="input-hd" placeholder="Sandi Baru (Opsional)">
                    <button onclick="updateProfile()" class="btn-main" style="background: var(--text-main);">SIMPAN PERUBAHAN</button>
                </div>
            </div>

            <div class="app-shell">
                <div class="section">
                    <h1>Menu Dompet</h1>
                    <div id="wallet-type-picker" class="flex gap-2" style="margin-bottom: 25px; justify-content: center;">
                        <div onclick="selectWalletIcon('üí≥')" class="wallet-icon-item" data-icon="üí≥">üí≥</div>
                        <div onclick="selectWalletIcon('üì±')" class="wallet-icon-item" data-icon="üì±">üì±</div>
                        <div onclick="selectWalletIcon('üíµ')" class="wallet-icon-item" data-icon="üíµ">üíµ</div>
                        <div onclick="selectWalletIcon('üè¶')" class="wallet-icon-item" data-icon="üè¶">üè¶</div>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="new-wallet-name" class="input-hd" placeholder="Nama Dompet Baru" style="margin:0;">
                        <button onclick="addNewWallet()" class="nav-btn" style="background:var(--success); color:white; width: 65px; height: 50px; border-radius: 20px; font-weight: 900; font-size: 20px;">+</button>
                    </div>
                    <div id="wallets-manage-list" style="margin-top:25px;"></div>
                </div>
            </div>

            <div class="app-shell">
                <div class="section">
                    <h1>Menu Kategori</h1>
                    <div class="flex gap-2">
                        <select id="new-cat-icon" class="input-hd" style="width: 75px; margin: 0; padding: 12px; font-size: 1.2rem;">
                            <option value="üí∏">üí∏</option><option value="üíπ">üíπ</option><option value="üç±">üç±</option><option value="üçø">üçø</option>
                            <option value="üéÆ">üéÆ</option><option value="‚öΩ">‚öΩ</option><option value="üéÅ">üéÅ</option><option value="üíá">üíá</option>
                        </select>
                        <input type="text" id="new-cat-name" class="input-hd" placeholder="Nama Kategori..." style="margin:0;">
                        <button onclick="addNewCategory()" class="nav-btn" style="background:var(--primary); color:white; width: 65px; height: 50px; border-radius: 20px; font-weight: 900; font-size: 20px;">+</button>
                    </div>
                    <div id="categories-manage-list" style="margin-top:25px;"></div>
                </div>
            </div>

            <button onclick="handleLogout()" style="width:100%; padding:22px; border-radius:var(--radius-M); background:#fee2e2; color:#b91c1c; font-weight:800; border:none; cursor:pointer; font-size: 0.9rem; letter-spacing: 1px;">KELUAR SESI</button>
        </div>

        <nav class="bottom-nav" id="bottom-nav">
            <div class="nav-item active" id="nav-finance" onclick="switchView('finance')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg></div>
            <div class="nav-item" id="nav-bills" onclick="switchView('bills')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg></div>
            <div class="nav-item" id="nav-goals" onclick="switchView('goals')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg></div>
            <div class="nav-item" id="nav-budget" onclick="switchView('budget')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055zM20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/></svg></div>
            <div class="nav-item" id="nav-report" onclick="switchView('report')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg></div>
            <div class="nav-item" id="nav-options" onclick="switchView('options')"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg></div>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal-exit" class="modal"><div class="modal-content" style="text-align: center;"><h3>Keluar Sesi?</h3><div class="grid-2" style="margin-top: 25px;"><button onclick="closeExitModal(false)" class="btn-main" style="background: var(--input-bg); color: var(--text-main); box-shadow: none;">Batal</button><button onclick="closeExitModal(true)" class="btn-main">Keluar</button></div></div></div>
    <div id="modal-confirm" class="modal"><div class="modal-content" style="text-align: center;"><h3>Konfirmasi</h3><p id="confirm-msg" class="text-muted" style="margin: 20px 0 30px 0;"></p><div class="grid-2"><button onclick="closeConfirm(false)" class="btn-main" style="background: var(--input-bg); color: var(--text-main); box-shadow: none;">Batal</button><button onclick="closeConfirm(true)" class="btn-main" style="background: var(--danger);">Eksekusi</button></div></div></div>
    <div id="modal-prompt" class="modal"><div class="modal-content"><h3 id="prompt-title" style="margin-bottom: 25px; text-align: center;">Update Nilai</h3><input type="text" id="prompt-input" class="input-hd" style="text-align: center; font-size: 1.7rem; padding: 24px; color: var(--primary);" oninput="formatAmountInput(this)"><div class="grid-2"><button onclick="closePrompt(false)" class="btn-main" style="background: var(--input-bg); color: var(--text-main); box-shadow: none;">Batal</button><button onclick="closePrompt(true)" class="btn-main">Simpan</button></div></div></div>
    <div id="pay-confirm-modal" class="modal"><div class="modal-content" style="text-align:center;"><h3>Pembayaran</h3><p id="pay-detail" class="text-muted" style="margin-bottom:20px; font-weight: 800; color: var(--primary);"></p><div id="variable-amount-container" class="hide"><input type="text" id="pay-actual-amount" class="input-hd" style="text-align:center;" oninput="formatAmountInput(this)"></div><select id="pay-wallet-select" class="input-hd" style="text-align:center;"></select><div class="grid-2" style="margin-top: 15px;"><button onclick="toggleModal('pay-confirm-modal')" class="btn-main" style="background:var(--input-bg); color:var(--text-main); box-shadow: none;">Batal</button><button onclick="confirmPayment()" class="btn-main" style="background:var(--success);">Bayar</button></div></div></div>

    <script>
        /**
         * 1. INITIAL STATE & GLOBAL VARIABLES
         */
        window.activeView = 'finance';
        window.currentUser = null;
        window.users = JSON.parse(localStorage.getItem('kf_users')) || [{ id: 'u_1', username: 'admin', password: '123', displayName: '' }];
        window.transactions = [];
        window.wallets = [];
        window.bills = [];
        window.goals = [];
        window.budgets = [];
        window.categories = [
            { icon: 'üç±', name: 'Makan' }, { icon: 'üõí', name: 'Belanja' }, 
            { icon: '‚òï', name: 'Jajan' }, { icon: 'üöå', name: 'Transport' }, 
            { icon: 'üõçÔ∏è', name: 'Hobi' }, { icon: 'üí°', name: 'Tagihan' }
        ];

        window.currentTxMode = 'income';
        window.selectedTxCategory = null;
        window.selectedBudgetCategory = null;
        window.selectedWalletIcon = 'üíµ';
        window.pendingBill = null;
        window.lastScrollTop = 0;
        window.confirmCallbackFn = null;
        window.promptCallbackFn = null;

        /**
         * 2. DATA PERSISTENCE FUNCTIONS
         */
        function saveData() {
            if(!window.currentUser) return;
            const uid = window.currentUser.id;
            try {
                localStorage.setItem(`kf_log_${uid}`, JSON.stringify(window.transactions));
                localStorage.setItem(`kf_wallets_${uid}`, JSON.stringify(window.wallets));
                localStorage.setItem(`kf_bills_${uid}`, JSON.stringify(window.bills));
                localStorage.setItem(`kf_goals_${uid}`, JSON.stringify(window.goals));
                localStorage.setItem(`kf_budgets_${uid}`, JSON.stringify(window.budgets));
                localStorage.setItem(`kf_cats_${uid}`, JSON.stringify(window.categories));
                localStorage.setItem('kf_users', JSON.stringify(window.users));
            } catch(e){}
        }

        function loadUserData() {
            if(!window.currentUser) return;
            const uid = window.currentUser.id;
            try {
                window.transactions = JSON.parse(localStorage.getItem(`kf_log_${uid}`)) || [];
                window.wallets = JSON.parse(localStorage.getItem(`kf_wallets_${uid}`)) || [
                    { id: 'w_1', name: 'TUNAI', balance: 0, icon: 'üíµ' }, 
                    { id: 'w_2', name: 'BANK', balance: 0, icon: 'üí≥' }
                ];
                window.bills = JSON.parse(localStorage.getItem(`kf_bills_${uid}`)) || [];
                window.goals = JSON.parse(localStorage.getItem(`kf_goals_${uid}`)) || [];
                window.budgets = JSON.parse(localStorage.getItem(`kf_budgets_${uid}`)) || [];
                const savedCats = JSON.parse(localStorage.getItem(`kf_cats_${uid}`)); if(savedCats) window.categories = savedCats;
            } catch(e){}
            
            const limit = 30 * 24 * 60 * 60 * 1000; const now = Date.now();
            window.transactions = window.transactions.filter(t => (now - (t.timestamp || 0)) < limit);
            window.selectedTxCategory = window.categories[0]; window.selectedBudgetCategory = window.categories[0];
            
            // UI Sync
            document.getElementById('edit-user').value = window.currentUser.username;
            document.getElementById('edit-name').value = window.currentUser.displayName || "";
            saveData();
        }

        /**
         * 3. UI UTILITIES & RENDERERS
         */
        function formatRupiah(n) { return "Rp " + (n || 0).toLocaleString('id-ID'); }
        function parseFormattedValue(str) { if(!str) return 0; return parseFloat(String(str).replace(/\./g, "")) || 0; }
        function formatAmountInput(input) { if(!input) return; let v = input.value.replace(/\D/g, ""); input.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
        function showNotice(msg) { const t = document.getElementById('toast'); if(t){ t.innerText = msg; t.style.opacity = 1; t.style.transform = "translateX(-50%) translateY(10px)"; setTimeout(() => { t.style.opacity = 0; t.style.transform = "translateX(-50%) translateY(-20px)"; }, 2000); } }
        function toggleModal(id) { const m = document.getElementById(id); if(m) m.classList.toggle('active'); }
        function applyTheme(isDark) { document.body.setAttribute('data-theme', isDark ? 'dark' : 'light'); try { localStorage.setItem('kf_theme', isDark ? 'dark' : 'light'); } catch(e){} }
        function selectWalletIcon(icon) { window.selectedWalletIcon = icon; document.querySelectorAll('.wallet-icon-item').forEach(el => { el.classList.toggle('selected', el.getAttribute('data-icon') === icon); }); }

        function renderBills() {
            const fl = document.getElementById('bill-list-full'); if(!fl) return;
            fl.innerHTML = window.bills.length === 0 ? '<p style="text-align:center; opacity:0.3; padding: 20px;">Belum ada tagihan.</p>' : '';
            window.bills.forEach(b => { fl.innerHTML += `<div class="item-row" style="background:var(--card-bg); border: 1.5px solid var(--border);"><div><b style="font-size:0.85rem;">${b.name}</b><br><small style="font-size:0.65rem;">Hingga: ${b.date}</small></div><div style="text-align:right;"><b style="font-size:0.85rem; display:block; color:var(--primary);">${b.isVariable?'Var':formatRupiah(b.amount)}</b><div style="display:flex; gap:8px; align-items:center; margin-top:4px;"><button onclick="initPayment('${b.id}')" style="background:var(--success); border:none; color:white; font-size:0.6rem; padding:6px 12px; border-radius:10px; font-weight:700;">BAYAR</button><button onclick="openConfirmModal('Hapus tagihan?', ()=>{deleteBillAction('${b.id}')})" style="color:var(--danger); background:none; border:none; font-size:14px; font-weight:900;">‚úï</button></div></div></div>`; });
        }
        function renderGoals() {
            const gl = document.getElementById('goals-list'); if(!gl) return;
            gl.innerHTML = window.goals.length === 0 ? '<p style="text-align:center; opacity:0.3;">Belum ada target.</p>' : '';
            window.goals.forEach(g => { const p = Math.min(Math.round((g.current/g.target)*100), 100); gl.innerHTML += `<div class="chart-container" style="background: var(--card-bg); border: 2px solid var(--border);"><div class="flex"><b>${g.name}</b><span style="font-weight:900; color:var(--primary);">${p}%</span></div><div class="glow-bar" style="height: 10px;"><div class="glow-fill-inc" style="width:${p}%"></div></div><div class="flex" style="margin-top:12px; font-size:0.75rem; font-weight:800;"><span>${formatRupiah(g.current)}</span><span class="text-muted">Target: ${formatRupiah(g.target)}</span></div><div style="text-align:right; margin-top:15px;"><button onclick="openPromptModal('Update', ${g.current}, (v)=>{updateGoalAction('${g.id}', v)})" style="background:var(--primary); border:none; color:white; font-weight:800; font-size:0.65rem; padding:5px 12px; border-radius:10px;">UPDATE</button><button onclick="openConfirmModal('Hapus?', ()=>{deleteGoalAction('${g.id}')})" style="background:rgba(225, 29, 72, 0.1); border:none; color:var(--danger); font-weight:800; font-size:0.65rem; margin-left:10px; padding:5px 12px; border-radius:10px;">HAPUS</button></div></div>`; });
        }
        function renderBudgets() {
            const bl = document.getElementById('budget-list'); if(!bl) return;
            bl.innerHTML = window.budgets.length === 0 ? '<p style="text-align:center; opacity:0.3;">Belum ada limit.</p>' : '';
            window.budgets.forEach(b => {
                const spent = window.transactions.filter(t => t.type === 'expense' && t.catIcon === b.icon).reduce((acc, curr) => acc + curr.amount, 0);
                const percent = Math.min(Math.round((spent / b.limit) * 100), 100);
                const color = percent >= 100 ? 'var(--danger)' : (percent > 85 ? 'var(--warning)' : 'var(--primary)');
                const warningTag = percent >= 100 ? '<span class="warning-badge">LIMIT TERCAPAI</span>' : '';
                bl.innerHTML += `<div class="chart-container" style="background: var(--card-bg); border: 2px solid var(--border);"><div class="flex"><b style="font-size:0.85rem">${b.icon} ${b.name}</b> ${warningTag} <span style="font-weight:900; color:${color}">${percent}%</span></div><div class="glow-bar" style="height: 10px;"><div style="height:100%; width:${percent}%; background: ${color};"></div></div><div class="flex" style="margin-top:12px; font-size:0.75rem; font-weight:800;"><span>${formatRupiah(spent)}</span><span class="text-muted">Batas: ${formatRupiah(b.limit)}</span></div><div style="text-align:right; margin-top:10px;"><button onclick="openConfirmModal('Hapus limit?', ()=>{deleteBudgetAction('${b.id}')})" style="background:rgba(225, 29, 72, 0.1); border:none; color:var(--danger); font-weight:800; font-size:0.65rem; padding:5px 12px; border-radius:10px;">HAPUS</button></div></div>`;
            });
        }

        function updateUI() {
            if(!window.currentUser) return;
            let total = 0; const wc = document.getElementById('wallets-container'); const ws = document.getElementById('wallet-select'); const wts = document.getElementById('wallet-to-select');
            if(wc) wc.innerHTML = ''; if(ws) ws.innerHTML = ''; if(wts) wts.innerHTML = '';
            window.wallets.forEach(w => {
                total += w.balance;
                if(wc) wc.innerHTML += `<div class="wallet-card"><div style="font-size: 26px; margin-bottom: 6px;">${w.icon || 'üè¶'}</div><p class="text-xs" style="margin-bottom: 2px; opacity:0.6; font-weight:800;">${w.name}</p><p style="font-weight:800; margin:0; font-size:1.15rem; color:var(--primary);">${formatRupiah(w.balance)}</p></div>`;
                if(ws) ws.innerHTML += `<option value="${w.id}">${w.icon || 'üè¶'} ${w.name}</option>`;
                if(wts) wts.innerHTML += `<option value="${w.id}">${w.icon || 'üè¶'} ${w.name}</option>`;
            });
            const tb = document.getElementById('total-balance'); if(tb) tb.innerText = formatRupiah(total);
            const list = document.getElementById('transaction-list');
            if (list) { list.innerHTML = window.transactions.length === 0 ? '<p style="text-align:center; opacity:0.3; padding:40px;">Belum ada riwayat</p>' : ''; window.transactions.slice().reverse().forEach(t => { list.innerHTML += `<div class="item-row" style="background:var(--card-bg); border:1.5px solid var(--border);"><div><b style="font-size:0.85rem;">${(t.catName || 'Umum').toUpperCase()}</b><br><small style="font-size:0.65rem; color:var(--text-muted); font-weight:700;">${t.date}</small></div><div style="font-weight:900; font-size: 0.95rem; color:${t.type=='income'?'var(--success)':'var(--danger)'}">${formatRupiah(t.amount)}</div></div>`; }); }
            renderBills(); renderGoals(); renderBudgets(); renderCategoriesManage(); renderWalletsManage(); updateReportChart();
        }

        function renderCategoriesManage() { const l = document.getElementById('categories-manage-list'); if(!l) return; l.innerHTML = ''; window.categories.forEach((cat, idx) => { l.innerHTML += `<div class="item-row" style="background:var(--input-bg);"><span>${cat.icon} ${cat.name}</span>${idx > 5 ? `<button onclick="openConfirmModal('Hapus?', ()=>{deleteCategoryAction(${idx})})" style="color:var(--danger); border:none; background:none; font-weight:800; font-size:0.75rem;">HAPUS</button>` : '<small style="opacity:0.3; font-size:0.55rem; font-weight:800;">SISTEM</small>'}</div>`; }); }
        function renderWalletsManage() { const l = document.getElementById('wallets-manage-list'); if(!l) return; l.innerHTML = ''; window.wallets.forEach(w => { l.innerHTML += `<div class="item-row" style="background:var(--input-bg);"><span>${w.icon || 'üè¶'} ${w.name}</span><div style="display:flex; gap:12px;"><button onclick="openPromptModal('Update', ${w.balance}, (v)=>{updateWalletAction('${w.id}', v)})" style="color:var(--primary); border:none; background:none; font-weight:800; font-size:0.75rem;">UPDATE</button><button onclick="openConfirmModal('Hapus?', ()=>{deleteWalletAction('${w.id}')})" style="color:var(--danger); border:none; background:none; font-weight:800; font-size:0.75rem;">HAPUS</button></div></div>`; }); }
        function renderPickers() {
            const tp = document.getElementById('tx-icon-picker'); if(tp){ tp.innerHTML = ''; window.categories.forEach(cat => { const d = document.createElement('div'); d.className = `category-item ${cat.icon === (window.selectedTxCategory && window.selectedTxCategory.icon) ? 'selected' : ''}`; d.innerHTML = `<span>${cat.icon}</span><span>${cat.name}</span>`; d.onclick = () => { window.selectedTxCategory = cat; renderPickers(); }; tp.appendChild(d); }); }
            const bp = document.getElementById('budget-icon-picker'); if(bp){ bp.innerHTML = ''; window.categories.forEach(cat => { const d = document.createElement('div'); d.className = `category-item ${cat.icon === (window.selectedBudgetCategory && window.selectedBudgetCategory.icon) ? 'selected' : ''}`; d.innerHTML = `<span>${cat.icon}</span><span>${cat.name}</span>`; d.onclick = () => { window.selectedBudgetCategory = cat; renderPickers(); }; bp.appendChild(d); }); }
            selectWalletIcon(window.selectedWalletIcon);
        }
        function updateReportChart() {
            const incFill = document.getElementById('chart-inc-fill'); const expFill = document.getElementById('chart-exp-fill');
            const tIn = window.transactions.filter(t => t.type === 'income').reduce((acc, curr) => acc + curr.amount, 0);
            const tOut = window.transactions.filter(t => t.type === 'expense').reduce((acc, curr) => acc + curr.amount, 0);
            document.getElementById('chart-inc-val').innerText = formatRupiah(tIn); document.getElementById('chart-exp-val').innerText = formatRupiah(tOut);
            const total = tIn + tOut; if(total > 0) { if(incFill) incFill.style.width = Math.round((tIn/total)*100)+'%'; if(expFill) expFill.style.width = Math.round((tOut/total)*100)+'%'; }
        }

        /**
         * 4. BUSINESS LOGIC & ACTIONS
         */
        function handleLogin() {
            const uInput = document.getElementById('login-user'); const pInput = document.getElementById('login-pass');
            if(!uInput || !pInput) return;
            const u = uInput.value.trim(); const p = pInput.value.trim();
            const user = window.users.find(x => x.username.toLowerCase() === u.toLowerCase() && x.password === p);
            if(user) { 
                window.currentUser = user; try { localStorage.setItem('kf_current_session', JSON.stringify(window.currentUser)); } catch(e){}
                loadUserData(); document.getElementById('login-screen').classList.add('hide'); document.getElementById('main-app').classList.remove('hide'); initApp(); 
            } else showNotice("Login Gagal");
        }
        function handleLogout() { try { localStorage.removeItem('kf_current_session'); } catch(e){} location.reload(); }
        function switchView(id) { window.activeView = id; ['finance', 'goals', 'bills', 'budget', 'report', 'options'].forEach(v => { const el = document.getElementById('view-' + v); const nav = document.getElementById('nav-' + v); if (el) el.classList.add('hide'); if (nav) nav.classList.remove('active'); }); const tv = document.getElementById('view-' + id); const tn = document.getElementById('nav-' + id); if(tv) tv.classList.remove('hide'); if(tn) tn.classList.add('active'); window.history.pushState({ view: id }, ""); }
        
        function processTransaction() {
            const amount = parseFormattedValue(document.getElementById('amount').value); const desc = document.getElementById('desc').value.trim(); const wId = document.getElementById('wallet-select').value;
            if(amount <= 0) return showNotice("Isi nominal!"); const w = window.wallets.find(x => x.id === wId);
            if(window.currentTxMode == 'income') w.balance += amount; else if(window.currentTxMode == 'expense') { 
                const budget = window.budgets.find(b => b.icon === window.selectedTxCategory.icon);
                if(budget) { const spent = window.transactions.filter(t => t.type === 'expense' && t.catIcon === window.selectedTxCategory.icon).reduce((acc, c) => acc + c.amount, 0); if(spent + amount > budget.limit) showNotice(`‚ö†Ô∏è Limit ${budget.name} Terlampaui!`); }
                w.balance -= amount; 
            }
            else if(window.currentTxMode == 'transfer') { const toId = document.getElementById('wallet-to-select').value; const toW = window.wallets.find(x => x.id === toId); if(!toW || toId === wId) return showNotice("Pilih tujuan!"); w.balance -= amount; toW.balance += amount; }
            window.transactions.push({ id: Date.now(), desc: desc.toUpperCase(), amount, type: window.currentTxMode, wallet: w.name, catIcon: window.selectedTxCategory.icon, catName: window.selectedTxCategory.name, date: new Date().toLocaleDateString('id-ID'), timestamp: Date.now() });
            saveData(); updateUI(); document.getElementById('desc').value = ''; document.getElementById('amount').value = ''; showNotice("Berhasil!");
        }

        function addNewBill() { const n = document.getElementById('bill-name').value; const d = document.getElementById('bill-date').value; const a = parseFormattedValue(document.getElementById('bill-amount').value); const isVar = document.getElementById('bill-is-variable').checked; if(!n || !d) return showNotice("Lengkapi form!"); window.bills.push({ id: 'bl_'+Date.now(), name: n.toUpperCase(), date: d, amount: a, isVariable: isVar }); saveData(); updateUI(); showNotice("Tagihan ditambah!"); }
        function initPayment(id) { window.pendingBill = window.bills.find(x => x.id == id); document.getElementById('pay-detail').innerText = `${window.pendingBill.name}`; if(window.pendingBill.isVariable) document.getElementById('variable-amount-container').classList.remove('hide'); else document.getElementById('variable-amount-container').classList.add('hide'); const sel = document.getElementById('pay-wallet-select'); if(sel) { sel.innerHTML = ''; window.wallets.forEach(w => sel.innerHTML += `<option value="${w.id}">${w.icon || 'üè¶'} ${w.name}</option>`); } toggleModal('pay-confirm-modal'); }
        function confirmPayment() { const wId = document.getElementById('pay-wallet-select').value; const w = window.wallets.find(x => x.id === wId); let final = window.pendingBill.isVariable ? parseFormattedValue(document.getElementById('pay-actual-amount').value) : window.pendingBill.amount; if(final <= 0) return showNotice("Isi nominal!"); w.balance -= final; window.transactions.push({ id: Date.now(), desc: `BAYAR: ${window.pendingBill.name}`, amount: final, type: 'expense', wallet: w.name, catIcon: 'üí°', catName: 'Tagihan', date: new Date().toLocaleDateString('id-ID'), timestamp: Date.now() }); const d = new Date(window.pendingBill.date); d.setMonth(d.getMonth() + 1); window.pendingBill.date = d.toISOString().split('T')[0]; saveData(); updateUI(); toggleModal('pay-confirm-modal'); showNotice("Lunas!"); }
        function addNewGoal() { const n = document.getElementById('goal-name').value.trim(); const t = parseFormattedValue(document.getElementById('goal-target').value); if(!n || t <= 0) return showNotice("Isi data!"); window.goals.push({ id: 'g_'+Date.now(), name: n.toUpperCase(), target: t, current: 0 }); saveData(); updateUI(); showNotice("Target dibuat!"); }
        function saveBudget() { const limit = parseFormattedValue(document.getElementById('budget-limit').value); if(limit <= 0) return showNotice("Isi nominal!"); const exists = window.budgets.findIndex(b => b.icon === window.selectedBudgetCategory.icon); if(exists !== -1) window.budgets[exists].limit = limit; else window.budgets.push({ id: 'b_'+Date.now(), icon: window.selectedBudgetCategory.icon, name: window.selectedBudgetCategory.name, limit: limit }); saveData(); updateUI(); showNotice("Limit disimpan!"); }
        function addNewWallet() { const n = document.getElementById('new-wallet-name').value.trim(); if(!n) return showNotice("Isi nama!"); window.wallets.push({ id: 'w_'+Date.now(), name: n.toUpperCase(), balance: 0, icon: window.selectedWalletIcon }); document.getElementById('new-wallet-name').value = ''; saveData(); updateUI(); showNotice("Dompet ditambah!"); }
        function addNewCategory() { const n = document.getElementById('new-cat-name').value.trim(); const i = document.getElementById('new-cat-icon').value; if(!n) return showNotice("Isi nama!"); window.categories.push({ icon: i, name: n.substring(0, 10) }); saveData(); updateUI(); renderPickers(); document.getElementById('new-cat-name').value = ''; showNotice("Kategori ditambah!"); }
        function updateProfile() { const dn = document.getElementById('edit-name').value.trim(); const u = document.getElementById('edit-user').value.trim(); const p = document.getElementById('edit-pass').value.trim(); if(!u) return showNotice("Isi Username!"); window.currentUser.username = u; window.currentUser.displayName = dn; if(p) window.currentUser.password = p; const idx = window.users.findIndex(us => us.id === window.currentUser.id); if(idx!==-1) window.users[idx] = window.currentUser; try { localStorage.setItem('kf_current_session', JSON.stringify(window.currentUser)); } catch(e){} saveData(); loadUserData(); showNotice("Selesai!"); }

        function deleteWalletAction(id) { window.wallets = window.wallets.filter(w => w.id != id); saveData(); updateUI(); }
        function updateWalletAction(id, val) { const w = window.wallets.find(x => x.id === id); if(w) w.balance = parseFormattedValue(val); saveData(); updateUI(); }
        function deleteCategoryAction(idx) { window.categories.splice(idx, 1); saveData(); updateUI(); renderPickers(); }
        function deleteBillAction(id) { window.bills = window.bills.filter(b => b.id != id); saveData(); updateUI(); }
        function deleteBudgetAction(id) { window.budgets = window.budgets.filter(b => b.id != id); saveData(); updateUI(); }
        function updateGoalAction(id, val) { const goal = window.goals.find(g => g.id == id); if(goal) goal.current = parseFormattedValue(val); saveData(); updateUI(); }
        function deleteGoalAction(id) { window.goals = window.goals.filter(g => g.id != id); saveData(); updateUI(); }
        function clearHistory() { window.transactions = []; saveData(); updateUI(); showNotice("Bersih!"); }

        function openConfirmModal(msg, callback) { document.getElementById('confirm-msg').innerText = msg; window.confirmCallbackFn = callback; toggleModal('modal-confirm'); }
        function closeConfirm(result) { toggleModal('modal-confirm'); if (result && window.confirmCallbackFn) window.confirmCallbackFn(); window.confirmCallbackFn = null; }
        function openPromptModal(title, defaultVal, callback) { document.getElementById('prompt-title').innerText = title; document.getElementById('prompt-input').value = defaultVal.toLocaleString('id-ID'); window.promptCallbackFn = callback; toggleModal('modal-prompt'); }
        function closePrompt(result) { const val = document.getElementById('prompt-input').value; toggleModal('modal-prompt'); if (result && window.promptCallbackFn) window.promptCallbackFn(val); window.promptCallbackFn = null; }
        function closeExitModal(confirmExit) { toggleModal('modal-exit'); if (confirmExit) { showNotice("Sesi ditutup."); } }

        function setTxMode(m) { 
            window.currentTxMode = m; 
            const colors = { income: 'var(--success)', expense: 'var(--danger)', transfer: 'var(--warning)' };
            ['income', 'expense', 'transfer'].forEach(x => { 
                const b = document.getElementById('btn-m-'+x); 
                if(b) { 
                    if(x === m) {
                        b.style.background = colors[x]; b.style.color = '#fff'; b.style.border = '2px solid transparent';
                    } else {
                        b.style.background = 'transparent'; b.style.color = colors[x]; b.style.border = '2px solid ' + colors[x];
                    }
                } 
            }); 
            const twc = document.getElementById('to-wallet-container'); if(twc) twc.classList.toggle('hide', m!=='transfer'); 
        }

        /**
         * 5. SYSTEM CORE
         */
        function initHistorySystem() {
            window.history.pushState({ view: window.activeView }, "");
            window.onpopstate = function() {
                const activeEl = document.activeElement;
                if(activeEl && (activeEl.tagName === 'INPUT' || activeEl.tagName === 'TEXTAREA' || activeEl.tagName === 'SELECT')) {
                    activeEl.blur(); window.history.pushState({ view: window.activeView }, ""); return;
                }
                if (window.currentUser) {
                    if (window.activeView !== 'finance') { switchView('finance'); window.history.pushState({ view: 'finance' }, ""); }
                    else { toggleModal('modal-exit'); window.history.pushState({ view: 'finance' }, ""); }
                } else { toggleModal('modal-exit'); window.history.pushState({ view: 'login' }, ""); }
            };
        }

        function initApp() { 
            setInterval(() => { const cd = document.getElementById('clock-display'); if(cd) cd.innerText = new Date().toLocaleTimeString('id-ID'); }, 1000); 
            updateUI(); renderPickers(); initHistorySystem(); 
            setTxMode('income');
        }

        // Object Assign for Global Handlers
        Object.assign(window, {
            handleLogin, applyTheme, switchView, toggleModal, setTxMode, formatAmountInput, 
            processTransaction, addNewGoal, saveBudget, updateProfile, addNewWallet, 
            addNewCategory, handleLogout, closeConfirm, closePrompt, closeExitModal, 
            addNewBill, confirmPayment, deleteWalletAction, updateWalletAction, 
            deleteCategoryAction, deleteBillAction, deleteBudgetAction, updateGoalAction, 
            deleteGoalAction, openConfirmModal, openPromptModal, initPayment, clearHistory,
            selectWalletIcon
        });

        window.onload = () => { 
            const session = localStorage.getItem('kf_current_session'); 
            if(session) { 
                try {
                    window.currentUser = JSON.parse(session); 
                    document.getElementById('login-screen').classList.add('hide'); 
                    document.getElementById('main-app').classList.remove('hide'); 
                    loadUserData(); initApp(); 
                    if(localStorage.getItem('kf_theme') === 'dark') { applyTheme(true); const dmt = document.getElementById('dark-mode-toggle'); if(dmt) dmt.checked = true; } 
                } catch(e){ localStorage.removeItem('kf_current_session'); }
            } else { initHistorySystem(); }
        };

        window.addEventListener("scroll", function() { 
            let st = window.pageYOffset || document.documentElement.scrollTop; 
            const nav = document.getElementById('bottom-nav'); 
            if (nav) { if (st > window.lastScrollTop && st > 50) nav.classList.add('nav-hidden'); else nav.classList.remove('nav-hidden'); } 
            window.lastScrollTop = st <= 0 ? 0 : st; 
        }, false);
    </script>
</body>
</html>